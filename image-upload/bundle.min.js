!function(t){"use strict";var e=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,n=t.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}(),a=n&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),i=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,o=(n||i)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(t){var e,o,r,l,u,s;for(e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),o=new ArrayBuffer(e.length),r=new Uint8Array(o),l=0;l<e.length;l+=1)r[l]=e.charCodeAt(l);return u=t.split(",")[0].split(":")[1].split(";")[0],n?new Blob([a?r:o],{type:u}):(s=new i,s.append(o),s.getBlob(u))};t.HTMLCanvasElement&&!e.toBlob&&(e.mozGetAsFile?e.toBlob=function(t,n,a){t(a&&e.toDataURL&&o?o(this.toDataURL(n,a)):this.mozGetAsFile("blob",n))}:e.toDataURL&&o&&(e.toBlob=function(t,e,n){t(o(this.toDataURL(e,n)))})),"function"==typeof define&&define.amd?define(function(){return o}):t.dataURLtoBlob=o}(window),window.resize=function(){"use strict";function t(){}return t.prototype={init:function(t){this.outputQuality="undefined"===t?.8:t},photo:function(t,e,n,a){var i=this,o=new FileReader;o.onload=function(t){i.resize(t.target.result,e,n,a)},o.readAsDataURL(t)},resize:function(t,e,n,a){var i=this,o=new Image;o.onload=function(t){var r=document.createElement("canvas"),l=o.width,u=o.height;l>u?l>e&&(u*=e/l,l=e):u>e&&(l*=e/u,u=e),r.width=l,r.height=u,r.getContext("2d").drawImage(o,0,0,l,u),i.output(r,n,a)},o.src=t},output:function(t,e,n){switch(e){case"file":t.toBlob(function(t){n(t)},"image/jpeg",.8);break;case"dataURL":n(t.toDataURL("image/jpeg",.8))}}},t}(),window.resize=function(){"use strict";function t(){}return t.prototype={init:function(t){this.outputQuality="undefined"===t?.8:t},photo:function(t,e,n,a){var i=this,o=new FileReader;o.onload=function(t){i.resize(t.target.result,e,n,a)},o.readAsDataURL(t)},resize:function(t,e,n,a){var i=this,o=new Image;o.onload=function(t){var r=document.createElement("canvas"),l=o.width,u=o.height;l>u?l>e&&(u*=e/l,l=e):u>e&&(l*=e/u,u=e),r.width=l,r.height=u,r.getContext("2d").drawImage(o,0,0,l,u),i.output(r,n,a)},o.src=t},output:function(t,e,n){switch(e){case"file":t.toBlob(function(t){n(t)},"image/jpeg",.8);break;case"dataURL":n(t.toDataURL("image/jpeg",.8))}}},t}(),function($){$.fn.imageUpload=function(t){var e={getUrlResponseObject:function(t){return t.url}},n=$.extend(e,t),a=new window.resize;a.init();var i={upload:function(t,e,n,a){var i=new FormData;i.append("photo",e),i.append("meta",n);var o=new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState&&a(o.response)},o.open("POST",t),o.responseType="json",o.send(i)},dataURLtoBlob:function(t){var e;e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],a=new Uint8Array(e.length),i=0;i<e.length;i++)a[i]=e.charCodeAt(i);return new Blob([a],{type:n})},fileSize:function(t){var e=Math.floor(Math.log(t)/Math.log(1024));return 1*(t/Math.pow(1024,e)).toFixed(2)+" "+["B","kB","MB","GB","TB"][e]},setThumbnail:function(t,e,n){var a=$('<div class="form-image-upload-thumbnail"><div class="close-overlay"><a href="#"><i class="remove huge icon"></i>'+n+'</a></div><img src=""></div></div>');a.find("img").attr("src",e),t.empty().append(a)},setButtonLabel:function(t,e){t.find("span").text(e)}};return this.each(function(){var t=$(this).parent(),e=t.find(".button"),o=t.find("input[type=file]"),r=t.find("input[type=hidden]"),l=t.data("upload-url"),u=t.data("upload-meta-data")||{},s=t.data("image-width"),c=t.data("thumb-width"),d=$(t.data("thumb-container")),f=t.data("attach-label"),p=t.data("replace-label"),h=t.data("remove-label");""!==r.val()&&i.setThumbnail(d,r.val(),h),d.on("click",function(t){t.preventDefault(),d.empty(),i.setButtonLabel(e,f),r.val("")}),e.on("click",function(t){t.preventDefault(),o.click()}),o.on("change",function(t){t.preventDefault();var o=t.target.files;o.length>0&&e.toggleClass("loading");for(var f in o){if("object"!=typeof o[f])return!1;!function(){var t=o[f].size;a.photo(o[f],s,"file",function(t){var o=t.size;i.upload(l,t,u,function(o){r.val(n.getUrlResponseObject(o)),i.setButtonLabel(e,p),e.hasClass("red")&&e.removeClass("red").addClass("basic"),a.photo(t,c,"dataURL",function(t){i.setThumbnail(d,t,h),e.toggleClass("loading")})})})}()}})})}}(jQuery);