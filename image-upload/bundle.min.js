!function(t){"use strict";var e=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,a=t.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}(),n=a&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),o=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,i=(a||o)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(t){var e,i,r,l,s,u;for(e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),i=new ArrayBuffer(e.length),r=new Uint8Array(i),l=0;l<e.length;l+=1)r[l]=e.charCodeAt(l);return s=t.split(",")[0].split(":")[1].split(";")[0],a?new Blob([n?r:i],{type:s}):(u=new o,u.append(i),u.getBlob(s))};t.HTMLCanvasElement&&!e.toBlob&&(e.mozGetAsFile?e.toBlob=function(t,a,n){t(n&&e.toDataURL&&i?i(this.toDataURL(a,n)):this.mozGetAsFile("blob",a))}:e.toDataURL&&i&&(e.toBlob=function(t,e,a){t(i(this.toDataURL(e,a)))})),"function"==typeof define&&define.amd?define(function(){return i}):t.dataURLtoBlob=i}(window),window.resize=function(){"use strict";function t(){}return t.prototype={init:function(t){this.outputQuality="undefined"===t?.8:t},photo:function(t,e,a,n,o){var i=this,r=new FileReader;r.onload=function(r){var l=new FileReader;l.onload=function(l){for(var s,u="",d=new Uint8Array(l.target.result).subarray(0,4),c=0;c<d.length;c++)u+=d[c].toString(16);switch(u){case"89504e47":s="image/png";break;case"47494638":s="image/gif";break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":s="image/jpeg";break;default:s=t.type;break}o&&(s=o),i.resize(r.target.result,s,e,a,n)},l.readAsArrayBuffer(t)},r.readAsDataURL(t)},resize:function(t,e,a,n,o){var i=this,r=new Image;r.onload=function(t){var l=document.createElement("canvas"),s=r.width,u=r.height;s>u?s>a&&(u*=a/s,s=a):u>a&&(s*=a/u,u=a),l.width=s,l.height=u,l.getContext("2d").drawImage(r,0,0,s,u),i.output(l,e,n,o)},r.src=t},output:function(t,e,a,n){switch(a){case"file":t.toBlob(function(t){n(t)},e,.8);break;case"dataURL":n(t.toDataURL(e,.8));break}}},t}(),function($){$.fn.imageUpload=function(t){var e={getUrlResponseObject:function(t){return t.url}},a=$.extend(e,t),n=new window.resize;n.init();var o={upload:function(t,e,a,n){var o=new FormData;o.append("photo",e),o.append("meta",a);var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&n(i.response)},i.open("POST",t),i.responseType="json",i.send(o)},dataURLtoBlob:function(t){var e;e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var a=t.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(e.length),o=0;o<e.length;o++)n[o]=e.charCodeAt(o);return new Blob([n],{type:a})},fileSize:function(t){var e=Math.floor(Math.log(t)/Math.log(1024));return 1*(t/Math.pow(1024,e)).toFixed(2)+" "+["B","kB","MB","GB","TB"][e]},setThumbnail:function(t,e,a,n){var o=$('<div class="form-image-upload-thumbnail"><div class="menu-overlay"><a href="#" class="remove-anchor"><i class="remove large icon"></i>'+a+'</a><a href="'+e+'" class="download-anchor" target="_blank"><i class="download large icon"></i>'+n+'</a></div><img src=""></div></div>');o.find("img").attr("src",e),t.empty().append(o)},setButtonLabel:function(t,e){t.find("span").text(e)}};return this.each(function(){var t=$(this).parent(),e=t.find(".button"),i=t.find("input[type=file]"),r=t.find("input[type=hidden]"),l=t.data("upload-url"),s=t.data("upload-meta-data")||null,u=t.data("image-width"),d=t.data("thumb-width"),c=$(t.data("thumb-container")),f=t.data("attach-label"),p=t.data("replace-label"),b=t.data("remove-label"),h=t.data("download-label"),m=t.data("no-thumb-container"),v=null;1===m&&(c.before($('<div id="'+t.data("thumb-container").replace("#","").replace(".","")+'-no-thumb" class="form-image-upload-no-thumbnail"></div>')),v=$(t.data("thumb-container")+"-no-thumb")),""!==r.val()?o.setThumbnail(c,r.val(),b,h):v&&v.css("display","block"),c.find("a.remove-anchor").on("click",function(t){t.preventDefault(),c.empty(),o.setButtonLabel(e,f),r.val(""),v&&v.css("display","block")}),e.on("click",function(t){t.preventDefault(),i.click()}),i.on("change",function(t){t.preventDefault();var i=t.target.files;i.length>0&&e.toggleClass("loading");for(var f in i){if("object"!=typeof i[f])return!1;!function(){var t=i[f].size;n.photo(i[f],u,"file",function(t){var i=t.size;o.upload(l,t,s,function(i){r.val(a.getUrlResponseObject(i)),o.setButtonLabel(e,p),e.hasClass("red")&&e.removeClass("red").addClass("basic"),n.photo(t,d,"dataURL",function(t){v&&v.css("display","none"),o.setThumbnail(c,t,b),e.toggleClass("loading")})})})}()}})})}}(jQuery);