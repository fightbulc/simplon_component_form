!function(t){"use strict";var e=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,n=t.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}(),a=n&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),o=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,i=(n||o)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(t){var e,i,r,l,s,u;for(e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),i=new ArrayBuffer(e.length),r=new Uint8Array(i),l=0;l<e.length;l+=1)r[l]=e.charCodeAt(l);return s=t.split(",")[0].split(":")[1].split(";")[0],n?new Blob([a?r:i],{type:s}):(u=new o,u.append(i),u.getBlob(s))};t.HTMLCanvasElement&&!e.toBlob&&(e.mozGetAsFile?e.toBlob=function(t,n,a){t(a&&e.toDataURL&&i?i(this.toDataURL(n,a)):this.mozGetAsFile("blob",n))}:e.toDataURL&&i&&(e.toBlob=function(t,e,n){t(i(this.toDataURL(e,n)))})),"function"==typeof define&&define.amd?define(function(){return i}):t.dataURLtoBlob=i}(window),window.resize=function(){"use strict";function t(){}return t.prototype={init:function(t){this.outputQuality="undefined"===t?.8:t},photo:function(t,e,n,a,o){var i=this,r=new FileReader;r.onload=function(r){var l=new FileReader;l.onload=function(l){for(var s,u="",f=new Uint8Array(l.target.result).subarray(0,4),d=0;d<f.length;d++)u+=f[d].toString(16);switch(u){case"89504e47":s="image/png";break;case"47494638":s="image/gif";break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":s="image/jpeg";break;default:s=t.type}o&&(s=o),i.resize(r.target.result,s,e,n,a)},l.readAsArrayBuffer(t)},r.readAsDataURL(t)},resize:function(t,e,n,a,o){var i=this,r=new Image;r.onload=function(t){var l=document.createElement("canvas"),s=r.width,u=r.height;s>u?s>n&&(u*=n/s,s=n):u>n&&(s*=n/u,u=n),l.width=s,l.height=u,l.getContext("2d").drawImage(r,0,0,s,u),i.output(l,e,a,o)},r.src=t},output:function(t,e,n,a){switch(n){case"file":t.toBlob(function(t){a(t)},e,.8);break;case"dataURL":a(t.toDataURL(e,.8))}}},t}(),function($){$.fn.imageUpload=function(t){var e={getUrlResponseObject:function(t){return t.url}},n=$.extend(e,t),a=new window.resize;a.init();var o={upload:function(t,e,n,a){var o=new FormData;o.append("photo",e),o.append("meta",n);var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&a(i.response)},i.open("POST",t),i.responseType="json",i.send(o)},dataURLtoBlob:function(t){var e;e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],a=new Uint8Array(e.length),o=0;o<e.length;o++)a[o]=e.charCodeAt(o);return new Blob([a],{type:n})},fileSize:function(t){var e=Math.floor(Math.log(t)/Math.log(1024));return 1*(t/Math.pow(1024,e)).toFixed(2)+" "+["B","kB","MB","GB","TB"][e]},setThumbnail:function(t,e,n){var a=$('<div class="form-image-upload-thumbnail"><div class="close-overlay"><a href="#"><i class="remove huge icon"></i>'+n+'</a></div><img src=""></div></div>');a.find("img").attr("src",e),t.empty().append(a)},setButtonLabel:function(t,e){t.find("span").text(e)}};return this.each(function(){var t=$(this).parent(),e=t.find(".button"),i=t.find("input[type=file]"),r=t.find("input[type=hidden]"),l=t.data("upload-url"),s=t.data("upload-meta-data")||null,u=t.data("image-width"),f=t.data("thumb-width"),d=$(t.data("thumb-container")),c=t.data("attach-label"),p=t.data("replace-label"),h=t.data("remove-label");""!==r.val()&&o.setThumbnail(d,r.val(),h),d.on("click",function(t){t.preventDefault(),d.empty(),o.setButtonLabel(e,c),r.val("")}),e.on("click",function(t){t.preventDefault(),i.click()}),i.on("change",function(t){t.preventDefault();var i=t.target.files;i.length>0&&e.toggleClass("loading");for(var c in i){if("object"!=typeof i[c])return!1;!function(){var t=i[c].size;a.photo(i[c],u,"file",function(t){var i=t.size;o.upload(l,t,s,function(i){r.val(n.getUrlResponseObject(i)),o.setButtonLabel(e,p),e.hasClass("red")&&e.removeClass("red").addClass("basic"),a.photo(t,f,"dataURL",function(t){o.setThumbnail(d,t,h),e.toggleClass("loading")})})})}()}})})}}(jQuery);